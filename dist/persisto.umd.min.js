!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).mar10={})}(this,(function(t){"use strict";
/*!
     * persisto.js - utils
     * Copyright (c) 2016-2021, Martin Wendt. Released under the MIT license.
     * v2.0.1-0, Sun, 28 Feb 2021 08:26:51 GMT (https://github.com/mar10/persisto)
     */const e=9007199254740991;class s{constructor(){this.thens=[],this.catches=[],this.status=""}resolve(t){if(this.status)throw new Error("already settled");this.status="resolved",this.resolvedValue=t,this.thens.forEach((e=>e(t))),this.thens=[]}reject(t){if(this.status)throw new Error("already settled");this.status="rejected",this.rejectedError=t,this.catches.forEach((e=>e(t))),this.catches=[]}then(t){"resolved"===status?t(this.resolvedValue):this.thens.unshift(t)}catch(t){"rejected"===this.status?t(this.rejectedError):this.catches.unshift(t)}promise(){return{then:this.then,catch:this.catch}}}function i(t,e,s,i,o){"string"==typeof t&&(t=document.querySelector(t)),t.addEventListener(e,(function(t){if(t.target&&t.target.matches(s))return o?i.call(o,t):i(t)}))}function o(t,e,s){switch("string"==typeof t&&(t=document.querySelector(t)),s){case!0:t.classList.add(e);break;case!1:t.classList.remove(e);break;default:t.classList.toggle(e)}}function n(t,e){if(null==t)return t;let s=t.length,i=0;if("number"==typeof s)for(;i<s&&!1!==e.call(t[i],i,t[i]);i++);else for(let s in t)if(!1===e.call(t[s],s,t[s]))break;return t}function a(t){throw new Error(t)}function h(...t){for(let e=1;e<t.length;e++){let s=t[e];for(let e in s)Object.prototype.hasOwnProperty.call(s,e)&&(t[0][e]=s[e])}return t[0]}function l(){}
/*!
     * persisto.js
     *
     * Persistent JavaScript objects and web forms using Web Storage.
     *
     * Copyright (c) 2016-2021, Martin Wendt (https://wwWendt.de).
     * Released under the MIT license.
     *
     * @version v2.0.1-0
     * @date Sun, 28 Feb 2021 08:26:51 GMT
     */var r,c;!function(t){t.Ok="ok",t.Modified="modified",t.Loading="loading",t.Saving="saving",t.Error="error"}(r||(r={})),function(t){t.Idle="",t.Push="push",t.Pull="pull"}(c||(c={}));t.PersistentObject=class{constructor(t,e){this.version="v2.0.1-0",this._checkTimer=null,this.offline=void 0,this.phase=c.Idle,this.status=r.Ok,this.uncommittedSince=0,this.unpushedSince=0,this.lastUpdate=0,this.lastPull=0,this.commitCount=0,this.pushCount=0,this.lastModified=0;let o=new s;this.namespace=t,t||a("Missing required argument: namespace"),this.opts=h({remote:null,defaults:{},attachForm:null,statusElement:null,commitDelay:500,createParents:!0,maxCommitDelay:3e3,pushDelay:5e3,maxPushDelay:3e4,storage:window.localStorage,debugLevel:1,change:l,update:l,commit:l,conflict:l,error:l,pull:l,push:l,save:l,status:l},e),this.storage=this.opts.storage,this._data=this.opts.defaults,"string"==typeof this.opts.attachForm?this.form=document.querySelector(this.opts.attachForm):this.opts.attachForm instanceof HTMLElement&&(this.form=this.opts.attachForm),"string"==typeof this.opts.statusElement?this.statusElement=document.querySelector(this.opts.statusElement):this.opts.statusElement instanceof HTMLElement&&(this.statusElement=this.opts.statusElement);let n=this.storage?this.storage.getItem(this.namespace):null,u=this;this.form&&(this.form.classList.add("persisto"),i(this.form,"input","input,textarea",(function(t){u.readFromForm(u.form)})),i(this.form,"change","select",(function(t){u.readFromForm(u.form)})),this.form.addEventListener("submit",(function(t){u.readFromForm(u.form),t.preventDefault()})),this.form.addEventListener("reset",(function(t){u.readFromForm(u.form),t.preventDefault()}))),this.opts.remote?this.pull().then((function(){u.debug("init from remote",u._data),u.offline=!1,o.resolve()})).catch((function(){u.offline=!0,null==n?console.warn(u+": could not init from remote; falling back default.",arguments):(console.warn(u+": could not init from remote; falling back to storage.",arguments),u._data=h({},u.opts.defaults,JSON.parse(n))),o.resolve()})):null!=n?(this.update(),this._data=h({},this.opts.defaults,this._data),o.resolve()):o.resolve()}_setStatus(t){function e(e){if(e)for(let s in r)s=s.toLocaleLowerCase(),o(e,"persisto-"+s,t===s)}this.debug("status "+this.status+" => "+t),this.status=t,e(this.form),e(this.statusElement),this.opts.status.call(this,t)}_invalidate(t,s){let i=this,o=Date.now(),n=this.lastModified||o,a=0,h=0,l=0;this._checkTimer&&(clearTimeout(this._checkTimer),this._checkTimer=null),s?this.debug("_invalidate() recursive"):(this.lastModified=o,this.uncommittedSince||(this.uncommittedSince=o),this.unpushedSince||(this.unpushedSince=o),this.opts.change.call(this,t),this._setStatus(r.Modified)),this.storage&&(o-n>=this.opts.commitDelay||o-this.uncommittedSince>=this.opts.maxCommitDelay?(this.debug("_invalidate(): force commit",o-n>=this.opts.commitDelay,o-this.uncommittedSince>=this.opts.maxCommitDelay),this.commit()):a=Math.min(o+this.opts.commitDelay+1,this.uncommittedSince+this.opts.maxCommitDelay+1)),this.opts.remote&&(o-n>=this.opts.pushDelay||o-this.unpushedSince>=this.opts.maxPushDelay?(this.debug("_invalidate(): force push",o-n>=this.opts.pushDelay,o-this.unpushedSince>=this.opts.maxPushDelay),this.push()):h=Math.min(o+this.opts.pushDelay+1,this.unpushedSince+this.opts.maxPushDelay+1)),(a||h)&&(l=Math.min(a||e,h||e),this.debug("_invalidate("+t+") defer by "+(l-o)+"ms"),this._checkTimer=setTimeout((function(){i._checkTimer=null,i._invalidate.call(i,"deferred "+t,!0)}),l-o))}_update(t){this.uncommittedSince&&(console.warn("Updating an uncommitted object."),!1===this.opts.conflict.call(this,t,this._data))||(this._data=t,this.opts.update.call(this),this.lastUpdate=Date.now())}toString(){return"PersistentObject('"+this.namespace+"')"}debug(...t){this.opts.debugLevel>=2&&(Array.prototype.unshift.call(t,this.toString()),console.log.apply(console,t))}log(...t){this.opts.debugLevel>=1&&(Array.prototype.unshift.call(t,this.toString()),console.log.apply(console,t))}isDirty(){return!!(this.storage&&this.uncommittedSince||this.opts.remote&&this.unpushedSince)}isReady(){a("Not implemented")}get(t){let e,s=this._data,i=(""+t).replace(/\[(\w+)\]/g,".$1").replace(/^\./,"").split(".");for(e=0;e<i.length;e++)s=s[i[e]],void 0===s&&e<i.length-1&&a(this+": Property '"+t+"' could not be accessed because parent '"+i.slice(0,e+1).join(".")+"' does not exist");return s}_setOrRemove(t,e,s){let i,o,n=this._data,h=(""+t).replace(/\[(\w+)\]/g,".$1").replace(/^\./,"").split("."),l=h.pop();for(i=0;i<h.length;i++)o=n,n=o[h[i]],void 0===n&&(this.opts.createParents?(this.debug("Creating intermediate parent '"+h[i]+"'"),n=o[h[i]]={}):a(this+": Property '"+t+"' could not be set because parent '"+h.slice(0,i+1).join(".")+"' does not exist"));n[l]!==e&&(!0===s?(delete n[l],this._invalidate("remove")):(n[l]=e,this._invalidate("set")))}set(t,e){return this._setOrRemove(t,e,!1)}remove(t){return this._setOrRemove(t,void 0,!0)}reset(t){this._data=t||{},this._invalidate("reset")}setDirty(t){console.log("setDirty",t),!1!==t&&this._invalidate("explicit")}update(){this.phase&&a(this+": Trying to update while '"+this.phase+"' is pending."),this.opts.debugLevel>=2&&console.time&&console.time(this+".update");let t=this.storage.getItem(this.namespace);t=JSON.parse(t),this._update(t),this.opts.debugLevel>=2&&console.time&&console.timeEnd(this+".update")}commit(){let t;return this.phase&&a(this+": Trying to commit while '"+this.phase+"' is pending."),this.opts.debugLevel>=2&&console.time&&console.time(this+".commit"),t=JSON.stringify(this._data),this.storage.setItem(this.namespace,t),this.uncommittedSince=0,this.commitCount+=1,this.opts.remote||this._setStatus(r.Ok),this.opts.debugLevel>=2&&console.time&&console.timeEnd(this+".commit"),this.opts.commit.call(this),this.opts.remote||(this.opts.save.call(this),this.lastModified=0),t}pull(){let t=this;return this.phase&&a(this+": Trying to pull while '"+this.phase+"' is pending."),this.opts.debugLevel>=2&&console.time&&console.time(this+".pull"),this.phase=c.Pull,t._setStatus(r.Loading),fetch(this.opts.remote,{method:"GET"}).then((function(e){return e.ok?t.opts.pull.call(t,e):a("GET "+t.opts.remote+" returned "+e.status+", "+e),e.json()})).then((function(e){t.storage.setItem(t.namespace,JSON.stringify(e)),t._update.call(t,e),t._setStatus(r.Ok),t.lastPull=Date.now(),t.opts.pull.call(t)})).catch((function(){console.error(arguments),t._setStatus(r.Error),t.opts.error.call(t,arguments)})).finally((function(){t.phase=c.Idle,t.opts.debugLevel>=2&&console.time&&console.timeEnd(t+".pull")}))}push(){let t,e=this;return this.uncommittedSince?(this.phase&&(console.error("Resetting phase: "+this.phase),this.phase=c.Idle),t=this.commit()):t=JSON.stringify(this._data),this.phase&&a(this+": Trying to push while '"+this.phase+"' is pending."),this.opts.debugLevel>=2&&console.time&&console.time(e+".push"),this.phase=c.Push,this.opts.remote||a(this+": Missing remote option"),this._setStatus(r.Saving),fetch(this.opts.remote,{method:"PUT",body:t,headers:{"Content-Type":"application/json"}}).then((function(t){t.ok||a("PUT "+e.opts.remote+" returned "+t.status+", "+t),e.unpushedSince=0,e.pushCount+=1,e._setStatus(r.Ok),e.opts.push.call(e,t),e.opts.save.call(e)})).catch((function(){e._setStatus(r.Error),e.opts.error.call(e,arguments)})).finally((function(){e.phase=c.Idle,e.opts.debugLevel>=2&&console.time&&console.timeEnd(e+".push")}))}readFromForm(t,e){let s=this,i=h({addNew:!1,coerce:!0,trim:!0},e);if("string"==typeof(t=t||this.form)&&(t=document.querySelector(t)),i.addNew){let e=t.querySelectorAll("[name]");for(let t=0;t<e.length;t++){let i=e[t].getAttribute("name");void 0===s._data[i]&&(s.debug("readFromForm: add field '"+i+"'"),s._data[i]=null)}}n(this._data,(function(e,o){let n,a,h=t.querySelectorAll("[name='"+e+"']"),l=h[0];h.length?(a=l.getAttribute("type"),"radio"===a?n=t[e].value:"checkbox"===a&&1===h.length?n=!!l.checked:"checkbox"===a&&h.length>1?(n=[],h.forEach((function(t){t.checked&&n.push(t.value)}))):l.matches("select")?l.multiple?(n=[],Array.from(l.selectedOptions).forEach((function(t){n.push(t.value)}))):n=l.options[l.selectedIndex].value:(n=l.value,i.trim&&"string"==typeof n&&(n=n.trim())),s.set(e,n)):s.debug("readFromForm: field not found: '"+e+"'")}))}writeToForm(t,e){let s,i,o,a=this;"string"==typeof(t=t||this.form)&&(t=document.querySelector(t)),n(this._data,(function(e){let n=a.get(e),h=Array.isArray(n),l=t.querySelectorAll("[name='"+e+"']");if(!l.length)return;let r=l[0],c=r.getAttribute("type");if("radio"===c)l.forEach((function(t){t.checked=t.value===n}));else if("checkbox"===c)if(1===l.length)r.checked=!!n;else for(s=0;s<l.length;s++)i=l[s],o=h?n.indexOf(i.value)>=0:i.value===n,i.checked=o;else if(r.matches("select"))for(s=0;s<r.options.length;s++)i=r.options[s],o=h?n.indexOf(i.value)>=0:i.value===n,i.selected=o;else"file"===c||(r.value=n)}))}},Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=persisto.umd.min.js.map