!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).mar10={})}(this,(function(e){"use strict";
/*!
     * persisto.js - utils
     * Copyright (c) 2016-2021, Martin Wendt (https://wwWendt.de)
     * Released under the MIT license
     */const t=9007199254740991;class s{constructor(){this.thens=[],this.catches=[],this.status=""}resolve(e){if(this.status)throw new Error("already fulfilled");this.status="resolved",this.resolvedValue=e,this.thens.forEach((t=>t(e))),this.thens=[]}reject(e){if(this.status)throw new Error("already fulfilled");this.status="rejected",this.rejectedError=e,this.catches.forEach((t=>t(e))),this.catches=[]}then(e){"resolved"===status?e(this.resolvedValue):this.thens.unshift(e)}catch(e){"rejected"===this.status?e(this.rejectedError):this.catches.unshift(e)}promise(){return{then:this.then,catch:this.catch}}}function i(e,t){if(null==e)return e;let s=e.length,i=0;if("number"==typeof s)for(;i<s&&!1!==t.call(e[i],i,e[i]);i++);else for(let s in e)if(!1===t.call(e[s],s,e[s]))break;return e}function o(e){throw new Error(e)}function n(...e){for(let t=1;t<e.length;t++){let s=e[t];for(let t in s)Object.prototype.hasOwnProperty.call(s,t)&&(e[0][t]=s[t])}return e[0]}function h(){}
/*!
     * persisto.js
     *
     * Persistent JavaScript objects and web forms using Web Storage.
     *
     * Copyright (c) 2016-2021, Martin Wendt (https://wwWendt.de)
     * Released under the MIT license
     *
     * @version @VERSION
     * @date @DATE
     */e.PersistentObject=class{constructor(e,t){this.version="@VERSION",this._checkTimer=null,this.offline=void 0,this.phase=null,this.uncommittedSince=0,this.unpushedSince=0,this.lastUpdate=0,this.lastPull=0,this.commitCount=0,this.pushCount=0,this.lastModified=0;let i=new s;this.namespace=e,e||o("Missing required argument: namespace"),this.opts=n({remote:null,defaults:{},commitDelay:500,createParents:!0,maxCommitDelay:3e3,pushDelay:5e3,maxPushDelay:3e4,storage:window.localStorage,debugLevel:2,change:h,commit:h,conflict:h,error:h,pull:h,push:h,update:h},t),this.storage=this.opts.storage,this._data=this.opts.defaults;let l=this.storage?this.storage.getItem(this.namespace):null,a=this;this.opts.remote?this.pull().then((function(){a.debug("init from remote",a._data),a.offline=!1,i.resolve()})).catch((function(){a.offline=!0,null==l?console.warn(a+": could not init from remote; falling back default.",arguments):(console.warn(a+": could not init from remote; falling back to storage.",arguments),a._data=n({},a.opts.defaults,JSON.parse(l))),i.resolve()})):null!=l?(this.update(),this._data=n({},this.opts.defaults,this._data),i.resolve()):i.resolve()}_invalidate(e,s){let i=this,o=this.lastModified,n=Date.now(),h=0,l=0,a=0;this._checkTimer&&(clearTimeout(this._checkTimer),this._checkTimer=null),s?this.debug("_invalidate() recursive"):(this.lastModified=n,this.uncommittedSince||(this.uncommittedSince=n),this.unpushedSince||(this.unpushedSince=n),this.opts.change(e)),this.storage&&(0!==o&&(n-o>=this.opts.commitDelay||n-this.uncommittedSince>=this.opts.maxCommitDelay)?(this.debug("_invalidate(): force commit",n-o>=this.opts.commitDelay,n-this.uncommittedSince>=this.opts.maxCommitDelay,o),this.commit()):h=Math.min(n+this.opts.commitDelay+1,this.uncommittedSince+this.opts.maxCommitDelay+1)),this.opts.remote&&(n-o>=this.opts.pushDelay||n-this.unpushedSince>=this.opts.maxPushDelay?(this.debug("_invalidate(): force push",n-o>=this.opts.pushDelay,n-this.unpushedSince>=this.opts.maxPushDelay),this.push()):l=Math.min(n+this.opts.pushDelay+1,this.unpushedSince+this.opts.maxPushDelay+1)),(h||l)&&(a=Math.min(h||t,l||t),this.debug("_invalidate("+e+") defer by "+(a-n)+"ms"),this._checkTimer=setTimeout((function(){i._checkTimer=null,i._invalidate.call(i,"deferred "+e,!0)}),a-n))}_update(e){this.uncommittedSince&&(console.warn("Updating an uncommitted object."),!1===this.opts.conflict(e,this._data))||(this._data=e,this.lastUpdate=Date.now())}toString(){return"PersistentObject('"+this.namespace+"')"}debug(...e){this.opts.debugLevel>=2&&(Array.prototype.unshift.call(e,this.toString()),console.log.apply(console,e))}log(...e){this.opts.debugLevel>=1&&(Array.prototype.unshift.call(e,this.toString()),console.log.apply(console,e))}isDirty(){return!!(this.storage&&this.uncommittedSince||this.opts.remote&&this.unpushedSince)}isReady(){o("Not implemented")}get(e){let t,s=this._data,i=(""+e).replace(/\[(\w+)\]/g,".$1").replace(/^\./,"").split(".");for(t=0;t<i.length;t++)s=s[i[t]],void 0===s&&t<i.length-1&&o(this+": Property '"+e+"' could not be accessed because parent '"+i.slice(0,t+1).join(".")+"' does not exist");return s}_setOrRemove(e,t,s){let i,n,h=this._data,l=(""+e).replace(/\[(\w+)\]/g,".$1").replace(/^\./,"").split("."),a=l.pop();for(i=0;i<l.length;i++)n=h,h=n[l[i]],void 0===h&&(this.opts.createParents?(this.debug("Creating intermediate parent '"+l[i]+"'"),h=n[l[i]]={}):o(this+": Property '"+e+"' could not be set because parent '"+l.slice(0,i+1).join(".")+"' does not exist"));h[a]!==t&&(!0===s?(delete h[a],this._invalidate("remove")):(h[a]=t,this._invalidate("set")))}set(e,t){return this._setOrRemove(e,t,!1)}remove(e){return this._setOrRemove(e,void 0,!0)}reset(e){this._data=e||{},this._invalidate("reset")}setDirty(e){!1!==e&&this._invalidate("explicit")}update(){this.phase&&o(this+": Trying to update while '"+this.phase+"' is pending."),this.opts.debugLevel>=2&&console.time&&console.time(this+".update");let e=this.storage.getItem(this.namespace);e=JSON.parse(e),this._update(e),this.opts.debugLevel>=2&&console.time&&console.timeEnd(this+".update")}commit(){let e;return this.phase&&o(this+": Trying to commit while '"+this.phase+"' is pending."),this.opts.debugLevel>=2&&console.time&&console.time(this+".commit"),e=JSON.stringify(this._data),this.storage.setItem(this.namespace,e),this.uncommittedSince=0,this.commitCount+=1,this.opts.debugLevel>=2&&console.time&&console.timeEnd(this+".commit"),e}pull(){let e=this;return this.phase&&o(this+": Trying to pull while '"+this.phase+"' is pending."),this.opts.debugLevel>=2&&console.time&&console.time(this+".pull"),this.phase="pull",fetch(this.opts.remote,{method:"GET"}).then((function(t){return t.ok?e.opts.pull(arguments):o("GET "+e.opts.remote+" returned "+t.status+", "+t),t.json()})).then((function(t){e.storage.setItem(e.namespace,JSON.stringify(t)),e._update.call(e,t),e.lastPull=Date.now()})).catch((function(){console.error(arguments),e.opts.error(arguments)})).finally((function(){e.phase=null,e.opts.debugLevel>=2&&console.time&&console.timeEnd(e+".pull")}))}push(){let e=this,t=this.commit();return this.phase&&o(this+": Trying to push while '"+this.phase+"' is pending."),this.opts.debugLevel>=2&&console.time&&console.time(e+".push"),this.phase="push",this.opts.remote||o(this+": Missing remote option"),fetch(this.opts.remote,{method:"PUT",body:t,headers:{"Content-Type":"application/json"}}).then((function(t){t.ok?e.opts.push(arguments):o("PUT "+e.opts.remote+" returned "+t.status+", "+t),e.unpushedSince=0,e.pushCount+=1})).catch((function(){e.opts.error(arguments)})).finally((function(){e.phase=null,e.opts.debugLevel>=2&&console.time&&console.timeEnd(e+".push")}))}readFromForm(e,t){let s=this,o=n({addNew:!1,coerce:!0,trim:!0},t);if("string"==typeof e&&(e=document.querySelector(e)),o.addNew){let t=e.querySelectorAll("[name]");for(let e=0;e<t.length;e++){let i=t[e].getAttribute("name");void 0===s._data[i]&&(s.debug("readFromForm: add field '"+i+"'"),s._data[i]=null)}}i(this._data,(function(t,i){let n,h,l=e.querySelectorAll("[name='"+t+"']"),a=l[0];l.length?(h=a.getAttribute("type"),"radio"===h?n=e[t].value:"checkbox"===h&&1===l.length?n=!!a.checked:"checkbox"===h&&l.length>1?(n=[],l.forEach((function(e){e.checked&&n.push(e.value)}))):a.matches("select")?a.multiple?(n=[],Array.from(a.selectedOptions).forEach((function(e){n.push(e.value)}))):n=a.options[a.selectedIndex].value:(n=a.value,o.trim&&"string"==typeof n&&(n=n.trim())),s.set(t,n)):s.debug("readFromForm: field not found: '"+t+"'")}))}writeToForm(e,t){let s,o,n,h=this;"string"==typeof e&&(e=document.querySelector(e)),i(this._data,(function(t){let i=h.get(t),l=Array.isArray(i),a=e.querySelectorAll("[name='"+t+"']");if(!a.length)return;let r=a[0],c=r.getAttribute("type");if("radio"===c)a.forEach((function(e){e.checked=e.value===i}));else if("checkbox"===c)if(1===a.length)r.checked=!!i;else for(s=0;s<a.length;s++)o=a[s],n=l?i.indexOf(o.value)>=0:o.value===i,o.checked=n;else if(r.matches("select"))for(s=0;s<r.options.length;s++)o=r.options[s],n=l?i.indexOf(o.value)>=0:o.value===i,o.selected=n;else"file"===c||(r.value=i)}))}},Object.defineProperty(e,"__esModule",{value:!0})}));
