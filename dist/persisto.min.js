/*! Persistent JavaScript objects and web forms using Web Storage. - v1.3.0 - 2020-09-11 |  https://github.com/mar10/persisto |  Copyright (c) 2020 Martin Wendt; Licensed MIT */

!function(t){"function"==typeof define&&define.amd?define(["jquery"],t):"object"==typeof module&&module.exports?module.exports=t(require("jquery")):t(jQuery)}(function(r){"use strict";var u=9007199254740991,a=window.console,l=r.error;return window.PersistentObject=function(t,e){var i,s=this,n=r.Deferred(),o=Date.now();this instanceof PersistentObject||l("Must use 'new' keyword"),"string"!=typeof t&&l(this+": Missing required argument: namespace"),this.opts=r.extend({remote:null,defaults:{},commitDelay:500,createParents:!0,maxCommitDelay:3e3,pushDelay:5e3,maxPushDelay:3e4,storage:window.localStorage,debugLevel: 1,change:r.noop,commit:r.noop,conflict:r.noop,error:r.noop,pull:r.noop,push:r.noop,update:r.noop},e),this._checkTimer=null,this.namespace=t,this.storage=this.opts.storage,this._data=this.opts.defaults,this.offline=void 0,this.phase=null,this.uncommittedSince=null,this.unpushedSince=null,this.lastUpdate=0,this.lastPull=0,this.commitCount=0,this.pushCount=0,this.lastModified=o,this.ready=n.promise,i=this.storage?this.storage.getItem(this.namespace):null,this.opts.remote?this.pull().done(function(){s.offline=!1,n.resolve()}).fail(function(){s.offline=!0,null==i?a.warn(s+": could not init from remote; falling back default."):(a.warn(s+": could not init from remote; falling back to storage."),s._data=r.extend({},s.opts.defaults,JSON.parse(i))),n.resolve()}):(null!=i&&(this.update(),this._data=r.extend({},this.opts.defaults,this._data)),n.resolve())},window.PersistentObject.prototype={version:"1.3.0",_invalidate:function(t,e){var i=this,s=this.lastModified,n=Date.now(),o=0,a=0,h=0;this._checkTimer&&(clearTimeout(this._checkTimer),this._checkTimer=null),e?this.debug("_invalidate() recursive"):(this.lastModified=n,this.uncommittedSince||(this.uncommittedSince=n),this.unpushedSince||(this.unpushedSince=n),this.opts.change(t)),this.storage&&(n-s>=this.opts.commitDelay||n-this.uncommittedSince>=this.opts.maxCommitDelay?(this.debug("_invalidate(): force commit",n-s>=this.opts.commitDelay,n-this.uncommittedSince>=this.opts.maxCommitDelay),this.commit()):o=Math.min(n+this.opts.commitDelay+1,this.uncommittedSince+this.opts.maxCommitDelay+1)),this.opts.remote&&(n-s>=this.opts.pushDelay||n-this.unpushedSince>=this.opts.maxPushDelay?(this.debug("_invalidate(): force push",n-s>=this.opts.pushDelay,n-this.unpushedSince>=this.opts.maxPushDelay),this.push()):a=Math.min(n+this.opts.pushDelay+1,this.unpushedSince+this.opts.maxPushDelay+1)),(o||a)&&(h=Math.min(o||u,a||u),this.debug("_invalidate("+t+") defer by "+(h-n)+"ms"),this._checkTimer=setTimeout(function(){i._checkTimer=null,i._invalidate.call(i,null,!0)},h-n))},_update:function(t){this.uncommittedSince&&(a.warn("Updating an uncommitted object."),!1===this.conflict(t,this._data))||(this._data=t,this.lastUpdate=Date.now())},toString:function(){return"PersistentObject('"+this.namespace+"')"},debug:function(){2<=this.opts.debugLevel&&(Array.prototype.unshift.call(arguments,this.toString()),a.log.apply(a,arguments))},log:function(){1<=this.opts.debugLevel&&(Array.prototype.unshift.call(arguments,this.toString()),a.log.apply(a,arguments))},isDirty:function(){return!!(this.storage&&this.uncommittedSince||this.opts.remote&&this.unpushedSince)},isReady:function(){return"pending"!==this.ready.state},get:function(t){var e,i=this._data,s=(""+t).replace(/\[(\w+)\]/g,".$1").replace(/^\./,"").split(".");for(e=0;e<s.length;e++)void 0===(i=i[s[e]])&&e<s.length-1&&l(this+": Property '"+t+"' could not be accessed because parent '"+s.slice(0,e+1).join(".")+"' does not exist");return i},_setOrRemove:function(t,e,i){var s,n,o=this._data,a=(""+t).replace(/\[(\w+)\]/g,".$1").replace(/^\./,"").split("."),h=a.pop();for(s=0;s<a.length;s++)void 0===(o=(n=o)[a[s]])&&(this.opts.createParents?(this.debug("Creating intermediate parent '"+a[s]+"'"),o=n[a[s]]={}):l(this+": Property '"+t+"' could not be set because parent '"+a.slice(0,s+1).join(".")+"' does not exist"));o[h]!==e&&(!0===i?(delete o[h],this._invalidate("remove")):(o[h]=e,this._invalidate("set")))},set:function(t,e){return this._setOrRemove(t,e,!1)},remove:function(t){return this._setOrRemove(t,void 0,!0)},reset:function(t){this._data=t||{},this._invalidate("reset")},setDirty:function(t){!1!==t&&this._invalidate("explicit")},update:function(){this.phase&&l(this+": Trying to update while '"+this.phase+"' is pending."),2<=this.opts.debugLevel&&a.time&&a.time(this+".update");var t=this.storage.getItem(this.namespace);t=JSON.parse(t),this._update(t),2<=this.opts.debugLevel&&a.time&&a.timeEnd(this+".update")},commit:function(){var t;return this.phase&&l(this+": Trying to commit while '"+this.phase+"' is pending."),2<=this.opts.debugLevel&&a.time&&a.time(this+".commit"),t=JSON.stringify(this._data),this.storage.setItem(this.namespace,t),this.uncommittedSince=null,this.commitCount+=1,2<=this.opts.debugLevel&&a.time&&a.timeEnd(this+".commit"),t},pull:function(){var i=this;return this.phase&&l(this+": Trying to pull while '"+this.phase+"' is pending."),2<=this.opts.debugLevel&&a.time&&a.time(this+".pull"),this.phase="pull",r.ajax({type:"GET",url:this.opts.remote}).done(function(t){var e=t;r.isArray(t)||r.isPlainObject(t)?e=JSON.stringify(t):t=JSON.parse(t),i.storage.setItem(i.namespace,e),i._update(t),i.lastPull=Date.now()}).fail(function(){i.opts.error(arguments)}).always(function(){i.phase=null,2<=i.opts.debugLevel&&a.time&&a.timeEnd(i+".pull")})},push:function(){var t=this,e=this.commit();return this.phase&&l(this+": Trying to push while '"+this.phase+"' is pending."),2<=this.opts.debugLevel&&a.time&&a.time(t+".push"),this.phase="push",this.opts.remote||l(this+": Missing remote option"),r.ajax({type:"PUT",url:this.opts.remote,data:e}).done(function(){t.unpushedSince=null,t.pushCount+=1}).fail(function(){t.opts.error(arguments)}).always(function(){t.phase=null,2<=t.opts.debugLevel&&a.time&&a.timeEnd(t+".push")})},readFromForm:function(t,e){var o=this,a=r(t),h=r.extend({addNew:!1,coerce:!0,trim:!0},e);h.addNew&&a.find("[name]").each(function(){var t=r(this).attr("name");void 0===o._data[t]&&(o.debug("readFromForm: add field '"+t+"'"),o._data[t]=null)}),r.each(this._data,function(t,e){var i,s=a.find("[name='"+t+"']"),n=s.attr("type");s.length?("radio"===n?i=s.filter(":checked").val():"checkbox"===n&&1===s.length?i=!!s.filter(":checked").length:"checkbox"===n&&1<s.length?(i=[],s.filter(":checked").each(function(){i.push(r(this).val())})):(i=s.val(),h.trim&&"string"==typeof i&&(i=r.trim(i))),o.set(t,i)):o.debug("readFromForm: field not found: '"+t+"'")})},writeToForm:function(t,e){var n=r(t),o=this;r.each(this._data,function(t){var e=o.get(t),i=n.find("[name='"+t+"']"),s=i.attr("type");i.length&&("radio"===s?i.filter("[value='"+e+"']").prop("checked",!0):"checkbox"===s?1===i.length?i.prop("checked",!!e):i.each(function(){r(this).prop("checked",r.isArray(e)?0<=r.inArray(this.value,e):this.value===e)}):i.is("select")?i.find("option").each(function(){r(this).prop("selected",r.isArray(e)?0<=r.inArray(this.value,e):this.value===e)}):"file"===s||i.val(e))})}},window.PersistentObject});
//# sourceMappingURL=persisto.min.js.map